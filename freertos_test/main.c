
#include "stm32f4xx.h"
#include "stm32f4xx_gpio.h"
#include "stm32f4xx_rcc.h"
#include "stm32f4xx_tim.h"
#include "stm32f4xx_spi.h"
#include "stm32f4xx_dma.h"
#include <misc.h>
#include "system_stm32f4xx.h"

#include <stdio.h>
#include <math.h>

//FreeRTOS:

#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"
#include "semphr.h"


#include "tablo_parser.h"
#include "spi_bus.h"
#include "tablo.h"
#include "proto.h"
#include "keyboard.h"
#include "buzzer.h"
#include "power.h"
#include "watchdog.h"
#include "relay.h"
#include "power_detector.h"

extern struct tablo tab;//
static void Init_Task(void *pvParameters);//

const uint8_t test_frame[16][128]={
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x00,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x01,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x02,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x03,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x04,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x05,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x06,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x07,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x08,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x09,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x0A,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x0B,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x0C,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x0D,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x0E,0x5D},
		{0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x0F,0x5D}
};

extern const uint8_t standby_frame[];
static void Init_Task(void *pvParameters)
{
	uint8_t i=0;
	Power_Detector_Init();
	vTaskDelay(200);

	Power_Init();

	Watchdog_Init();

	spi1_config();
	spi2_config();
	spi3_config();

	tablo_devices_init();


	for(i=0;i<16;i++)
	{
		tablo_proto_parser(&test_frame[i]);
		vTaskDelay(100);
	}
	tablo_proto_parser(&standby_frame);

    Proto_Init(PROTO_FIRST_INIT);


//  keyboard_init();
    buzzer_init();
    Relay_Init();
    vTaskDelete( NULL );
}

int main(void)
{
	SystemInit();

    xTaskCreate(Init_Task,(signed char*)"INIT",128,NULL, tskIDLE_PRIORITY + 1, NULL);

    vTaskStartScheduler();

    while(1);
}
//---------------------------------------------------------------------------------------

void vApplicationTickHook( void )
{
	portBASE_TYPE xHigherPriorityTaskWoken = pdFALSE;
}
/*-----------------------------------------------------------*/

void vApplicationMallocFailedHook( void )
{
	for( ;; );
}
/*-----------------------------------------------------------*/

void vApplicationStackOverflowHook( xTaskHandle pxTask, signed char *pcTaskName )
{
	( void ) pcTaskName;
	( void ) pxTask;
	for( ;; );
}
/*-----------------------------------------------------------*/

void vApplicationIdleHook( void )
{
volatile size_t xFreeStackSpace;

	xFreeStackSpace = xPortGetFreeHeapSize();

	if( xFreeStackSpace > 100 )
	{
	}
}
